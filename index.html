<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Electric Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <style>
    /* --- å…¨åŸŸ Box Sizing & Body --- */
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; }
    
    /* --- éŸ¿æ‡‰å¼å®¹å™¨ (Container) --- */
    .container {
      width: 100%;
      padding: 0 15px;
      margin: 0 auto;
    }
    /* æ ¹æ“šä¸åŒè¢å¹•å°ºå¯¸è¨­å®šæœ€å¤§å¯¬åº¦ */
    @media (min-width: 576px) { .container { max-width: 540px; } }
    @media (min-width: 768px) { .container { max-width: 720px; } }
    @media (min-width: 992px) { .container { max-width: 960px; } }
    @media (min-width: 1200px) { .container { max-width: 1140px; } }

    /* --- æ·±è‰²æ¨¡å¼ (Dark Mode) æ¨£å¼ --- */
    .dark-mode {
      background-color: #1d1d1d !important;
      color: #fff !important;
    }
    .dark-mode .card {
      background-color: #2a2a2a !important;
      color: #fff !important;
    }
    .dark-mode input, .dark-mode select, .dark-mode textarea {
      background-color: #3a3a3a !important;
      color: #fff !important;
      border-color: #666 !important;
    }
    .dark-mode table {
      color: #fff !important;
    }
    .dark-mode table th {
      background-color: #444 !important;
      color: #fff !important;
    }
    .dark-mode table td {
      background-color: #2a2a2a !important;
      color: #fff !important;
      border-color: #444;
    }
    .dark-mode .btn, .dark-mode .btn-add, .dark-mode .btn-delete {
      color: #fff !important;
    }

    /* --- åœ–è¡¨æ¨£å¼ --- */
    #usageChart {
      min-height: 300px;
      width: 100% !important;
    }
    .card-chart {
      position: relative;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    /* --- éŸ¿æ‡‰å¼æ¨£å¼ (RWD) - 768px ä»¥ä¸‹ (å¹³æ¿/æ‰‹æ©Ÿ) --- */
    @media (max-width: 768px) {
      .card { margin-bottom: 1rem; }
      /* è®“è¡¨æ ¼å¯ä»¥æ°´å¹³æ»¾å‹• */
      .table-container { overflow-x: auto; }
      canvas { max-width: 100%; height: auto !important; }
      .row { margin: 0 -10px; }
      /* èª¿æ•´çµ±è¨ˆå¡ç‰‡æ’ç‰ˆ */
      .col-md-3 { width: 50%; padding: 0 10px; } 
      .col-md-4 { padding: 0 10px; }
      /* æ”¾å¤§è¡¨å–®å­—é«”ï¼Œæ–¹ä¾¿æ‰‹æ©Ÿè¼¸å…¥ */
      .form-control { font-size: 16px; }
      form .btn { width: 100%; margin-bottom: 10px; }
      /* å°è¦½åˆ—æŒ‰éˆ•å‚ç›´æ’åˆ— */
      .d-flex { flex-direction: column; }
      .d-flex .btn { margin: 5px 0; }
      #usageChart { min-height: 250px; }
    }

    /* --- éŸ¿æ‡‰å¼æ¨£å¼ (RWD) - 769px ~ 991px (å¹³æ¿) --- */
    @media (min-width: 769px) and (max-width: 991px) {
      .card { padding: 1.5rem !important; }
      .table td, .table th { padding: 0.5rem; }
      #usageChart { min-height: 280px; }
    }

    /* --- åˆ—å° (Print) æ¨£å¼ --- */
    @media print {
      /* åˆ—å°æ™‚éš±è—æŒ‰éˆ•å’Œå°è¦½åˆ— */
      .btn, .navbar { display: none !important; }
      /* ç§»é™¤å¡ç‰‡é‚Šæ¡†å’Œé™°å½± */
      .card { border: none !important; box-shadow: none !important; }
      body { font-size: 12pt; }
      .table { font-size: 10pt; }
    }

    /* --- SPA é é¢åˆ‡æ› --- */
    /* é è¨­éš±è—å…©å€‹é é¢ */
    #loginPage, #dashboardPage { display: none; }
    /* åªæœ‰ .active çš„é é¢æœƒé¡¯ç¤º */
    #loginPage.active, #dashboardPage.active { display: block; }
    
    /* --- è¡¨æ ¼ç”¨é›»é‡é«˜ä½ä¸Šè‰² --- */
    .usage-low {
      background-color: rgba(25, 135, 84, 0.1) !important; 
    }
    .usage-medium {
      background-color: rgba(255, 193, 7, 0.1) !important; 
    }
    .usage-high {
      background-color: rgba(220, 53, 69, 0.1) !important; 
    }

    /* --- æ·±è‰²æ¨¡å¼ä¸‹çš„è¡¨æ ¼ç”¨é›»é‡ä¸Šè‰² --- */
    .dark-mode .usage-low {
      background-color: rgba(25, 135, 84, 0.3) !important;
    }
    .dark-mode .usage-medium {
      background-color: rgba(255, 193, 7, 0.2) !important;
    }
    .dark-mode .usage-high {
      background-color: rgba(220, 53, 69, 0.3) !important;
    }
  </style>
</head>
<body class="bg-light">

  <div id="loginPage">
    <div class="container d-flex justify-content-center align-items-center vh-100">
      <div class="card shadow-lg p-4 rounded-4" style="max-width: 400px; width: 100%;">
        <h3 class="text-center mb-3"><i class="fa-solid fa-bolt text-warning"></i> Smart Electric Tracker</h3>
        
        <form id="loginForm" class="login-form">
          <div class="mb-3">
            <label class="form-label">å¸³è™Ÿ</label>
            <input type="text" id="loginUsername" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">å¯†ç¢¼</label>
            <input type="password" id="loginPassword" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">ç™»å…¥</button>
          <p class="text-center mt-3">æ²’æœ‰å¸³è™Ÿï¼Ÿ <a href="#" id="showRegister">è¨»å†Š</a></p>
        </form>
        
        <form id="registerForm" class="register-form d-none">
          <div class="mb-3">
            <label class="form-label">å»ºç«‹å¸³è™Ÿ</label>
            <input type="text" id="regUsername" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">å¯†ç¢¼</label>
            <input type="password" id="regPassword" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">ç¢ºèªå¯†ç¢¼</label>
            <input type="password" id="regConfirm" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-success w-100">è¨»å†Š</button>
          <p class="text-center mt-3">å·²æœ‰å¸³è™Ÿï¼Ÿ <a href="#" id="showLogin">ç™»å…¥</a></p>
        </form>

        <div id="msgBox" class="mt-3 text-center text-danger fw-bold"></div>
      </div>
    </div>
  </div>

  <div id="dashboardPage">
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #28a745;">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">é›»åƒ¹è¨ˆç®—</a>
        <div class="d-flex">
          <button id="toggleDark" class="btn btn-secondary me-2">ğŸŒ™</button>
          <button id="logoutBtn" class="btn btn-danger">ç™»å‡º</button>
        </div>
      </div>
    </nav>

    <div class="container my-4">
      <h2 class="page-title">æ­¡è¿, <span id="userName"></span></h2>

      <div class="card shadow-sm p-3 mb-4 bg-success-subtle border-success">
        <h5><i class="fa-solid fa-leaf"></i> ç¯€èƒ½å°æç¤º</h5>
        <p id="tipOfTheDay" class="mb-0">éš¨æ‰‹é—œç‡ˆï¼Œç¯€çœèƒ½æºã€‚</p>
      </div>
      
      <div class="mb-3 text-end">
        <button id="deleteRecordsBtn" class="btn btn-outline-danger">åˆªé™¤æ‰€æœ‰ç´€éŒ„</button>
      </div>

      <div class="row mb-4">
        <div class="col-md-3 col-6"> <div class="card shadow-sm p-3">
            <h5>ç¸½é›»è²»</h5>
            <p id="totalCost" class="fs-4 fw-bold">0 å…ƒ</p>
          </div>
        </div>
        <div class="col-md-3 col-6"> <div class="card shadow-sm p-3">
            <h5>ç¸½ç”¨é›»é‡</h5>
            <p id="totalUsage" class="fs-4 fw-bold">0 åº¦</p>
          </div>
        </div>
        <div class="col-md-3 col-6"> <div class="card shadow-sm p-3">
            <h5>å¹³å‡å–®åƒ¹</h5>
            <p id="avgPrice" class="fs-4 fw-bold">0 å…ƒ/åº¦</p>
          </div>
        </div>
        <div class="col-md-3 col-6"> <div class="card shadow-sm p-3">
            <h5>ç¸½ç¢³æ’æ”¾</h5>
            <p id="totalCO2" class="fs-4 fw-bold">0 kg</p>
          </div>
        </div>
      </div>
      
      <div class="card mb-4 p-3 shadow-sm">
        <h5>æ–°å¢é›»è²»ç´€éŒ„</h5>
        <form id="recordForm" class="row g-3">
          <div class="col-md-4">
            <input type="month" id="recordMonth" class="form-control" required>
          </div>
          <div class="col-md-4">
            <input type="number" id="recordUsage" class="form-control" placeholder="ç”¨é›»é‡ (åº¦)" required>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">æ–°å¢</button>
          </div>
        </form>
      </div>
      
      <div class="card shadow-sm p-3 mb-4">
        <h5>æ­·å²ç´€éŒ„</h5>
        <div class="table-container">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>æœˆä»½</th>
                <th>ç”¨é›»é‡ (åº¦)</th>
                <th>ç¸½é›»è²» (å…ƒ)</th>
                <th>å¹³å‡å–®åƒ¹ (å…ƒ/åº¦)</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="recordTableBody"></tbody>
          </table>
        </div>
      </div>
      
      <div class="card shadow-sm p-3 mb-4 card-chart">
        <h5>ç”¨é›»è¶¨å‹¢</h5>
        <div style="position: relative; width: 100%;">
          <canvas id="usageChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* --- DOM å…ƒç´ é¸å– --- */
    // ç²å–ç™»å…¥/è¨»å†Šç›¸é—œçš„è¡¨å–®å’ŒæŒ‰éˆ•
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const showRegister = document.getElementById("showRegister");
    const showLogin = document.getElementById("showLogin");
    const msgBox = document.getElementById("msgBox");
    // ç²å–å„€è¡¨æ¿çš„è¡¨æ ¼
    const recordTableBody = document.getElementById("recordTableBody");
    
    /* --- å…¨åŸŸè®Šæ•¸ --- */
    let users = {}; // ç”¨æ–¼å„²å­˜å¾ localStorage è®€å–çš„æ‰€æœ‰ä½¿ç”¨è€…è³‡æ–™
    let records = []; // ç”¨æ–¼å„²å­˜ã€Œç›®å‰ç™»å…¥è€…ã€çš„é›»è²»ç´€éŒ„

    /* --- éœæ…‹è³‡æ–™ï¼šç¯€èƒ½å°æç¤º --- */
    const energyTips = [
      "éš¨æ‰‹é—œç‡ˆï¼Œæ‹”æ‰ä¸ç”¨çš„é›»å™¨æ’é ­ã€‚",
      "å°‡å†·æ°£æº«åº¦è¨­å®šåœ¨ 26-28 åº¦ï¼Œæ­é…é›»æ‰‡ä½¿ç”¨æ›´çœé›»ã€‚",
      "å„ªå…ˆé¸è³¼å…·æœ‰ã€Œç¯€èƒ½æ¨™ç« ã€çš„é›»å™¨ç”¢å“ã€‚",
      "å®šæœŸæ¸…æ½”å†·æ°£æ¿¾ç¶²ï¼Œå¯æå‡å†·æˆ¿æ•ˆæœä¸¦çœé›»ã€‚",
      "ä½¿ç”¨ LED ç‡ˆæ³¡æ›¿æ›å‚³çµ±ç‡ˆæ³¡ï¼Œå¯ç¯€çœå¤§é‡é›»åŠ›ã€‚",
      "ç™½å¤©å¤šåˆ©ç”¨è‡ªç„¶å…‰ï¼Œæ¸›å°‘é–‹ç‡ˆæ™‚é–“ã€‚",
      "å†°ç®±ä¸è¦å¡å¤ªæ»¿ï¼Œä¸¦æ¸›å°‘é–‹é—œé–€æ¬¡æ•¸ã€‚"
    ];

    /* --- åŠŸèƒ½ï¼šé¡¯ç¤ºéš¨æ©Ÿç¯€èƒ½å°æç¤º --- */
    function showRandomTip() {
      const tipElement = document.getElementById("tipOfTheDay");
      if (tipElement) {
        // å¾æç¤ºé™£åˆ—ä¸­éš¨æ©ŸæŒ‘é¸ä¸€å€‹
        const randomIndex = Math.floor(Math.random() * energyTips.length);
        tipElement.textContent = energyTips[randomIndex];
      }
    }

    /* --- åŠŸèƒ½ï¼šåˆ‡æ›é é¢ (SPA æ ¸å¿ƒ) --- */
    // é€éåˆ‡æ› 'active' class ä¾†é¡¯ç¤ºæˆ–éš±è—ç™»å…¥é é¢æˆ–å„€è¡¨æ¿
    function showPage(pageId) {
      document.querySelectorAll('#loginPage, #dashboardPage').forEach(page => page.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
    }

    /* --- åŠŸèƒ½ï¼šè¼‰å…¥ä¸¦åˆå§‹åŒ–ä½¿ç”¨è€…è³‡æ–™ --- */
    function loadUserData() {
      // ç²å–ç•¶å‰ç™»å…¥è€…åç¨±
      const currentUser = localStorage.getItem("currentUser");
      // ç²å–æ‰€æœ‰ä½¿ç”¨è€…è³‡æ–™
      users = JSON.parse(localStorage.getItem("users")) || {};
      // å¾å…¨åŸŸ users ç‰©ä»¶ä¸­ï¼Œå–å¾—ç•¶å‰ä½¿ç”¨è€…çš„ records
      records = users[currentUser].records || [];
      
      // è¼‰å…¥è³‡æ–™å¾Œï¼Œé‡æ–°æ¸²æŸ“è¡¨æ ¼å’Œåœ–è¡¨
      renderTable();
      // é¡¯ç¤ºä¸€å‰‡éš¨æ©Ÿå°æç¤º
      showRandomTip(); 
    }

    /* --- åŠŸèƒ½ï¼šè¨ˆç®—å°é›»é›»è²» (ç´¯é€²è²»ç‡) --- */
    // æ ¹æ“šå°ç£çš„ç´¯é€²è²»ç‡è¨ˆç®—é›»è²»
    function calculateElectricityCostTaiPower(usage) {
      const brackets = [120, 330, 500, 700, 1000]; // ç”¨é›»ç´šè·
      const rates = [1.78, 2.55, 3.80, 5.14, 6.44, 8.86]; // å°æ‡‰è²»ç‡
      let cost = 0;
      // éæ­·æ‰€æœ‰ç´šè·ä¾†è¨ˆç®—ç¸½é›»è²»
      for (let i = 0; i <= brackets.length; i++) {
        const lower = i === 0 ? 0 : brackets[i - 1];
        const upper = i < brackets.length ? brackets[i] : Infinity;
        // è¨ˆç®—æ¯å€‹ç´šè·çš„è²»ç”¨ä¸¦ç´¯åŠ 
        cost += Math.min(Math.max(usage - lower, 0), upper - lower) * rates[i];
      }
      return { total: cost };
    }

    /* --- åŠŸèƒ½ï¼šæ›´æ–° Chart.js åœ–è¡¨ --- */
    function updateChart() {
      // å°‡ records é™£åˆ—è³‡æ–™è½‰æ›ç‚ºåœ–è¡¨éœ€è¦çš„æ ¼å¼
      usageChart.data.labels = records.map(r => r.month);
      usageChart.data.datasets[0].data = records.map(r => r.usage);
      // æ›´æ–°åœ–è¡¨
      usageChart.update();
    }

    /* --- åŠŸèƒ½ï¼šæ¸²æŸ“è¡¨æ ¼ & æ›´æ–°å„€è¡¨æ¿çµ±è¨ˆ --- */
    // é€™æ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼Œè² è²¬è¨ˆç®—ã€é¡¯ç¤ºæ‰€æœ‰è³‡æ–™
    function renderTable() {
      recordTableBody.innerHTML = ""; // æ¸…ç©ºè¡¨æ ¼
      let totalCost = 0, totalUsage = 0;
      const co2Factor = 0.495; // ç¢³æ’æ”¾ä¿‚æ•¸ (kg CO2 / åº¦)

      // éæ­·æ‰€æœ‰ç´€éŒ„
      records.forEach((rec, idx) => {
        const { total } = calculateElectricityCostTaiPower(rec.usage); // è¨ˆç®—å–®ç­†é›»è²»
        totalCost += total; // ç´¯åŠ ç¸½é›»è²»
        totalUsage += rec.usage; // ç´¯åŠ ç¸½ç”¨é›»
        const avgPrice = rec.usage ? (total / rec.usage).toFixed(2) : 0; // è¨ˆç®—å¹³å‡å–®åƒ¹

        // æ ¹æ“šç”¨é›»é‡é«˜ä½ï¼Œçµ¦äºˆä¸åŒçš„ class (ç”¨æ–¼ CSS ä¸Šè‰²)
        let usageClass = 'usage-low'; 
        if (rec.usage > 700) { 
          usageClass = 'usage-high';
        } else if (rec.usage > 330) { 
          usageClass = 'usage-medium';
        }
        
        // å°‡çµ„åˆå¥½çš„ HTML æ’å…¥è¡¨æ ¼ä¸­
        recordTableBody.insertAdjacentHTML('beforeend', `
          <tr class="${usageClass}">
            <td>${rec.month}</td>
            <td>${rec.usage}</td>
            <td>${total.toFixed(2)}</td>
            <td>${avgPrice}</td>
            <td><span class="btn-delete" data-idx="${idx}">åˆªé™¤</span></td>
          </tr>
        `);
      });

      // æ›´æ–°å„€è¡¨æ¿é ‚ç«¯çš„å››å€‹çµ±è¨ˆå¡ç‰‡
      document.getElementById("totalCost").textContent = totalCost.toFixed(2) + " å…ƒ";
      document.getElementById("totalUsage").textContent = totalUsage + " åº¦";
      document.getElementById("avgPrice").textContent = totalUsage ? (totalCost / totalUsage).toFixed(2) + " å…ƒ/åº¦" : "0 å…ƒ/åº¦";
      
      // è¨ˆç®—ä¸¦æ›´æ–°ç¸½ç¢³æ’æ”¾
      const totalCO2 = totalUsage * co2Factor;
      document.getElementById("totalCO2").textContent = totalCO2.toFixed(2) + " kg";
      
      // æœ€å¾Œï¼Œæ›´æ–°åœ–è¡¨
      updateChart();
    }

    /* --- äº‹ä»¶ç›£è½ï¼šé»æ“Šã€Œè¨»å†Šã€é€£çµ (åˆ‡æ›è¡¨å–®) --- */
    showRegister.addEventListener("click", e => {
      e.preventDefault(); // é˜²æ­¢é€£çµè·³è½‰
      loginForm.classList.add("d-none"); // éš±è—ç™»å…¥è¡¨å–®
      registerForm.classList.remove("d-none"); // é¡¯ç¤ºè¨»å†Šè¡¨å–®
      msgBox.textContent = ""; // æ¸…ç©ºè¨Šæ¯
    });

    /* --- äº‹ä»¶ç›£è½ï¼šé»æ“Šã€Œç™»å…¥ã€é€£çµ (åˆ‡æ›è¡¨å–®) --- */
    showLogin.addEventListener("click", e => {
      e.preventDefault(); // é˜²æ­¢é€£çµè·³è½‰
      registerForm.classList.add("d-none"); // éš±è—è¨»å†Šè¡¨å–®
      loginForm.classList.remove("d-none"); // é¡¯ç¤ºç™»å…¥è¡¨å–®
      msgBox.textContent = ""; // æ¸…ç©ºè¨Šæ¯
    });

    /* --- äº‹ä»¶ç›£è½ï¼šè¨»å†Šè¡¨å–®æäº¤ --- */
    registerForm.addEventListener("submit", e => {
      e.preventDefault(); // é˜²æ­¢è¡¨å–®é è¨­æäº¤
      // ç²å–è¼¸å…¥å€¼
      const username = document.getElementById("regUsername").value.trim();
      const password = document.getElementById("regPassword").value;
      const confirm = document.getElementById("regConfirm").value;

      // æª¢æŸ¥å¯†ç¢¼
      if (password !== confirm) {
        msgBox.textContent = "å¯†ç¢¼ä¸ä¸€è‡´";
        return;
      }

      // è®€å– localStorage
      users = JSON.parse(localStorage.getItem("users")) || {};
      // æª¢æŸ¥å¸³è™Ÿæ˜¯å¦å·²å­˜åœ¨
      if (users[username]) {
        msgBox.textContent = "å¸³è™Ÿå·²å­˜åœ¨";
        return;
      }

      // å»ºç«‹æ–°ä½¿ç”¨è€…ä¸¦åŒ…å«ç©ºç´€éŒ„é™£åˆ—
      users[username] = { password, records: [] };
      // å¯«å› localStorage
      localStorage.setItem("users", JSON.stringify(users));
      msgBox.textContent = "è¨»å†ŠæˆåŠŸ";
      
      // è¨»å†ŠæˆåŠŸå¾Œï¼Œè‡ªå‹•åˆ‡æ›å›ç™»å…¥è¡¨å–®
      registerForm.reset();
      registerForm.classList.add("d-none");
      loginForm.classList.remove("d-none");
    });

    /* --- äº‹ä»¶ç›£è½ï¼šç™»å…¥è¡¨å–®æäº¤ --- */
    loginForm.addEventListener("submit", e => {
      e.preventDefault(); // é˜²æ­¢è¡¨å–®é è¨­æäº¤
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value;
      
      // è®€å– localStorage
      users = JSON.parse(localStorage.getItem("users")) || {};

      // é©—è­‰å¸³è™Ÿ
      if (!users[username]) {
        msgBox.textContent = "ç„¡æ­¤å¸³è™Ÿ";
        return;
      }
      // é©—è­‰å¯†ç¢¼
      if (users[username].password !== password) {
        msgBox.textContent = "å¯†ç¢¼éŒ¯èª¤";
        return;
      }

      // ç™»å…¥æˆåŠŸï¼šå„²å­˜ä½¿ç”¨è€…ï¼Œä¸¦åˆ‡æ›åˆ°å„€è¡¨æ¿é é¢
      localStorage.setItem("currentUser", username);
      loginForm.reset();
      document.getElementById("userName").textContent = username;
      showPage('dashboardPage');
      
      // è¼‰å…¥è©²ä½¿ç”¨è€…çš„è³‡æ–™
      loadUserData();
    });

    /* --- äº‹ä»¶ç›£è½ï¼šé»æ“Šã€Œç™»å‡ºã€æŒ‰éˆ• --- */
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("currentUser"); // æ¸…é™¤ç™»å…¥ç‹€æ…‹
      showPage('loginPage'); // åˆ‡æ›å›ç™»å…¥é é¢
    });

    /* --- äº‹ä»¶ç›£è½ï¼šé»æ“Šã€Œåˆ‡æ›æ·±è‰²æ¨¡å¼ã€æŒ‰éˆ• --- */
    document.getElementById("toggleDark").addEventListener("click", () => {
      // åˆ‡æ› body çš„ 'dark-mode' class
      document.body.classList.toggle("dark-mode");
    });

    /* --- äº‹ä»¶ç›£è½ï¼šé»æ“Šã€Œåˆªé™¤æ‰€æœ‰ç´€éŒ„ã€æŒ‰éˆ• --- */
    document.getElementById("deleteRecordsBtn").addEventListener("click", () => {
      // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
      if (window.confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰é›»è²»ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) {
        const currentUser = localStorage.getItem("currentUser");
        records = []; // æ¸…ç©ºè¨˜æ†¶é«”ä¸­çš„ç´€éŒ„
        users[currentUser].records = records; // æ›´æ–°å…¨åŸŸ users ç‰©ä»¶
        localStorage.setItem("users", JSON.stringify(users)); // å¯«å› localStorage
        renderTable(); // é‡æ–°æ¸²æŸ“è¡¨æ ¼ (è®Šç‚ºç©ºç™½)
      }
    });

    /* --- äº‹ä»¶ç›£è½ï¼šæ–°å¢ç´€éŒ„è¡¨å–®æäº¤ --- */
    document.getElementById("recordForm").addEventListener("submit", e => {
      e.preventDefault(); // é˜²æ­¢è¡¨å–®é è¨­æäº¤
      const month = document.getElementById("recordMonth").value;
      const usage = parseFloat(document.getElementById("recordUsage").value);
      
      // æ–°å¢è³‡æ–™åˆ°è¨˜æ†¶é«”ä¸­çš„ records é™£åˆ—
      records.push({ month, usage });
      
      // æ›´æ–° localStorage
      const currentUser = localStorage.getItem("currentUser");
      users[currentUser].records = records;
      localStorage.setItem("users", JSON.stringify(users));
      
      renderTable(); // é‡æ–°æ¸²æŸ“è¡¨æ ¼
      e.target.reset(); // é‡è¨­è¡¨å–®
      showRandomTip(); // æ–°å¢å¾Œé¡¯ç¤ºæ–°çš„æç¤º
    });

    /* --- äº‹ä»¶ç›£è½ï¼šé»æ“Šè¡¨æ ¼ä¸­çš„ã€Œåˆªé™¤ã€ --- */
    // é€™æ˜¯ã€Œäº‹ä»¶å§”æ´¾ã€(Event Delegation)ï¼Œç›£è½æ•´å€‹ tbody
    recordTableBody.addEventListener("click", e => {
      // åˆ¤æ–·è¢«é»æ“Šçš„æ˜¯å¦ç‚ºã€Œåˆªé™¤ã€æŒ‰éˆ•
      if (e.target.classList.contains("btn-delete")) {
        const idx = e.target.dataset.idx; // ç²å– data-idx å±¬æ€§
        
        // å¾é™£åˆ—ä¸­åˆªé™¤è©²ç­†è³‡æ–™
        records.splice(idx, 1);
        
        // æ›´æ–° localStorage
        const currentUser = localStorage.getItem("currentUser");
        users[currentUser].records = records;
        localStorage.setItem("users", JSON.stringify(users));
        
        renderTable(); // é‡æ–°æ¸²æŸ“è¡¨æ ¼
      }
    });

    /* --- Chart.js åœ–è¡¨åˆå§‹åŒ– --- */
    const ctx = document.getElementById("usageChart").getContext("2d");
    const usageChart = new Chart(ctx, {
      type: "line", // è¨­å®šç‚ºæŠ˜ç·šåœ–
      data: {
        labels: [], // åˆå§‹ç‚ºç©ºï¼Œå°‡ç”± renderTable() å¡«å…¥
        datasets: [{
          label: "ç”¨é›»é‡ (åº¦)",
          data: [], // åˆå§‹ç‚ºç©º
          backgroundColor: "rgba(13,110,253,0.2)",
          borderColor: "#0d6efd",
          borderWidth: 2,
          fill: true // é¡¯ç¤ºç·šæ¢ä¸‹æ–¹çš„é¡è‰²
        }]
      },
      options: {
        responsive: true, // éŸ¿æ‡‰å¼
        maintainAspectRatio: false, // å…è¨±åœ–è¡¨ä¸æŒ‰åŸæ¯”ä¾‹ç¸®æ”¾
        scales: {
          y: { // Y è»¸è¨­å®š
            beginAtZero: true,
            ticks: { maxTicksLimit: 8 }
          },
          x: { // X è»¸è¨­å®š
            ticks: {
              maxRotation: 45, // æ¨™ç±¤æ—‹è½‰ 45 åº¦ï¼Œé˜²æ­¢é‡ç–Š
              minRotation: 45
            }
          }
        },
        plugins: {
          legend: { position: 'top' } // åœ–ä¾‹é¡¯ç¤ºåœ¨é ‚éƒ¨
        }
      }
    });

    /* --- ç¨‹å¼é€²å…¥é»ï¼šæª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ --- */
    // ç•¶é é¢è¼‰å…¥æ™‚ï¼Œæª¢æŸ¥ localStorage æ˜¯å¦æœ‰ 'currentUser'
    if (localStorage.getItem("currentUser")) {
      // å¦‚æœæœ‰ï¼Œè¡¨ç¤ºå·²ç™»å…¥
      document.getElementById("userName").textContent = localStorage.getItem("currentUser");
      showPage('dashboardPage'); // é¡¯ç¤ºå„€è¡¨æ¿
      loadUserData(); // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
    } else {
      // å¦‚æœæ²’æœ‰ï¼Œè¡¨ç¤ºæœªç™»å…¥
      showPage('loginPage'); // é¡¯ç¤ºç™»å…¥é é¢
    }
  </script>
</body>
</html>