<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Electric Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  
  <!-- æ¨£å¼å®šç¾©
    - åŸºç¤æ¨£å¼ï¼šç¢ºä¿é é¢å¸ƒå±€ä¸€è‡´æ€§
    - RWD æ–·é»ï¼š576px, 768px, 992px, 1200px
    - æ·±è‰²æ¨¡å¼ï¼šæ”¯æ´æ—¥/å¤œé–“åˆ‡æ›
    - éŸ¿æ‡‰å¼è¡¨æ ¼ï¼šæ”¯æ´è¡Œå‹•è£ç½®æ©«å‘æ²å‹•
    - åœ–è¡¨RWDï¼šç¢ºä¿åœ–è¡¨åœ¨å„ç¨®è¢å¹•å°ºå¯¸ä¸‹æ­£ç¢ºé¡¯ç¤º
    - åˆ—å°æ¨£å¼ï¼šå„ªåŒ–åˆ—å°è¼¸å‡ºæ ¼å¼
  -->
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; }
    .container {
      width: 100%;
      padding: 0 15px;
      margin: 0 auto;
    }
    @media (min-width: 576px) { .container { max-width: 540px; } }
    @media (min-width: 768px) { .container { max-width: 720px; } }
    @media (min-width: 992px) { .container { max-width: 960px; } }
    @media (min-width: 1200px) { .container { max-width: 1140px; } }

    .dark-mode {
      background-color: #1d1d1d !important;
      color: #fff !important;
    }
    .dark-mode .card {
      background-color: #2a2a2a !important;
      color: #fff !important;
    }
    .dark-mode input, .dark-mode select, .dark-mode textarea {
      background-color: #3a3a3a !important;
      color: #fff !important;
      border-color: #666 !important;
    }
    .dark-mode table {
      color: #fff !important;
    }
    .dark-mode table th {
      background-color: #444 !important;
      color: #fff !important;
    }
    .dark-mode table td {
      background-color: #2a2a2a !important;
      color: #fff !important;
      border-color: #444;
    }
    .dark-mode .btn, .dark-mode .btn-add, .dark-mode .btn-delete {
      color: #fff !important;
    }

    #usageChart {
      min-height: 300px;
      width: 100% !important;
    }
    .card-chart {
      position: relative;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    @media (max-width: 768px) {
      .card { margin-bottom: 1rem; }
      .table-container { overflow-x: auto; }
      canvas { max-width: 100%; height: auto !important; }
      .row { margin: 0 -10px; }
      .col-md-4 { padding: 0 10px; }
      .form-control { font-size: 16px; }
      form .btn { width: 100%; margin-bottom: 10px; }
      .d-flex { flex-direction: column; }
      .d-flex .btn { margin: 5px 0; }
      #usageChart { min-height: 250px; }
    }

    @media (min-width: 769px) and (max-width: 991px) {
      .card { padding: 1.5rem !important; }
      .table td, .table th { padding: 0.5rem; }
      #usageChart { min-height: 280px; }
    }

    @media print {
      .btn, .navbar { display: none !important; }
      .card { border: none !important; box-shadow: none !important; }
      body { font-size: 12pt; }
      .table { font-size: 10pt; }
    }

    #loginPage, #dashboardPage { display: none; }
    #loginPage.active, #dashboardPage.active { display: block; }
  </style>
</head>
<body class="bg-light">
  <div id="loginPage">
    <div class="container d-flex justify-content-center align-items-center vh-100">
      <div class="card shadow-lg p-4 rounded-4" style="max-width: 400px; width: 100%;">
        <h3 class="text-center mb-3"><i class="fas fa-bolt text-warning"></i> Smart Electric Tracker</h3>
        
        <form id="loginForm" class="login-form">
          <div class="mb-3">
            <label class="form-label">å¸³è™Ÿ</label>
            <input type="text" id="loginUsername" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">å¯†ç¢¼</label>
            <input type="password" id="loginPassword" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">ç™»å…¥</button>
          <p class="text-center mt-3">æ²’æœ‰å¸³è™Ÿï¼Ÿ <a href="#" id="showRegister">è¨»å†Š</a></p>
        </form>
        <form id="registerForm" class="register-form d-none">
          <div class="mb-3">
            <label class="form-label">å»ºç«‹å¸³è™Ÿ</label>
            <input type="text" id="regUsername" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">å¯†ç¢¼</label>
            <input type="password" id="regPassword" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">ç¢ºèªå¯†ç¢¼</label>
            <input type="password" id="regConfirm" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-success w-100">è¨»å†Š</button>
          <p class="text-center mt-3">å·²æœ‰å¸³è™Ÿï¼Ÿ <a href="#" id="showLogin">ç™»å…¥</a></p>
        </form>

        <div id="msgBox" class="mt-3 text-center text-danger fw-bold"></div>
      </div>
    </div>
  </div>
  <div id="dashboardPage">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Smart Electric Tracker</a>
        <div class="d-flex">
          <button id="toggleDark" class="btn btn-secondary me-2">ğŸŒ™</button>
          <button id="logoutBtn" class="btn btn-danger">ç™»å‡º</button>
        </div>
      </div>
    </nav>

    <div class="container my-4">
      <h2 class="page-title">æ­¡è¿, <span id="userName"></span></h2>

      <div class="mb-3 text-end">
        <button id="deleteRecordsBtn" class="btn btn-outline-danger">åˆªé™¤æ‰€æœ‰ç´€éŒ„</button>
      </div>

      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card shadow-sm p-3">
            <h5>ç¸½é›»è²»</h5>
            <p id="totalCost" class="fs-4 fw-bold">0 å…ƒ</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow-sm p-3">
            <h5>ç¸½ç”¨é›»é‡</h5>
            <p id="totalUsage" class="fs-4 fw-bold">0 åº¦</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow-sm p-3">
            <h5>å¹³å‡å–®åƒ¹</h5>
            <p id="avgPrice" class="fs-4 fw-bold">0 å…ƒ/åº¦</p>
          </div>
        </div>
      </div>
      <div class="card mb-4 p-3 shadow-sm">
        <h5>æ–°å¢é›»è²»ç´€éŒ„</h5>
        <form id="recordForm" class="row g-3">
          <div class="col-md-4">
            <input type="month" id="recordMonth" class="form-control" required>
          </div>
          <div class="col-md-4">
            <input type="number" id="recordUsage" class="form-control" placeholder="ç”¨é›»é‡ (åº¦)" required>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">æ–°å¢</button>
          </div>
        </form>
      </div>
      <div class="card shadow-sm p-3 mb-4">
        <h5>æ­·å²ç´€éŒ„</h5>
        <div class="table-container">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>æœˆä»½</th>
                <th>ç”¨é›»é‡ (åº¦)</th>
                <th>ç¸½é›»è²» (å…ƒ)</th>
                <th>å¹³å‡å–®åƒ¹ (å…ƒ/åº¦)</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="recordTableBody"></tbody>
          </table>
        </div>
      </div>
      <div class="card shadow-sm p-3 mb-4 card-chart">
        <h5>ç”¨é›»è¶¨å‹¢</h5>
        <div style="position: relative; width: 100%;">
          <canvas id="usageChart"></canvas>
        </div>
      </div>
    </div>
  </div>

    <!-- ç¨‹å¼é‚è¼¯
    åŠŸèƒ½æ¨¡çµ„ï¼š
    1. ä½¿ç”¨è€…èªè­‰ï¼šè¨»å†Šã€ç™»å…¥ã€ç™»å‡º
    2. é›»è²»ç´€éŒ„ç®¡ç†ï¼šæ–°å¢ã€åˆªé™¤ã€åˆ—è¡¨é¡¯ç¤º
    3. é›»è²»è¨ˆç®—ï¼šç´¯é€²é›»åƒ¹è¨ˆç®—
    4. æ•¸æ“šè¦–è¦ºåŒ–ï¼šè¶¨å‹¢åœ–è¡¨
    5. ä»‹é¢æ§åˆ¶ï¼šæ·±è‰²æ¨¡å¼ã€é é¢åˆ‡æ›
    
    è³‡æ–™å­˜å„²ï¼š
    - ä½¿ç”¨ localStorage å„²å­˜ä½¿ç”¨è€…è³‡æ–™èˆ‡é›»è²»ç´€éŒ„
    - è³‡æ–™çµæ§‹ï¼š{
        users: {
          [username]: {
            password: string,
            records: Array<{month: string, usage: number}>
          }
        }
      }
  -->
  <script>
    // DOM å…ƒç´ å¿«å–
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const showRegister = document.getElementById("showRegister");
    const showLogin = document.getElementById("showLogin");
    const msgBox = document.getElementById("msgBox");
    const recordTableBody = document.getElementById("recordTableBody");
    let users = {};
    let records = [];

    // é é¢åˆ‡æ›æ§åˆ¶ï¼šåœ¨ç™»å…¥é å’Œä¸»æ§å°ä¹‹é–“åˆ‡æ›
    function showPage(pageId) {
      document.querySelectorAll('#loginPage, #dashboardPage').forEach(page => page.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
    }

    // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™ï¼šå¾ localStorage è®€å–ç•¶å‰ä½¿ç”¨è€…çš„é›»è²»ç´€éŒ„
    function loadUserData() {
      const currentUser = localStorage.getItem("currentUser");
      users = JSON.parse(localStorage.getItem("users")) || {};
      records = users[currentUser].records || [];
      renderTable();
    }

    // é›»è²»è¨ˆç®—ï¼šå°é›»ç´¯é€²é›»åƒ¹è¨ˆç®—
    // brackets: å„ç´šè·ç”¨é›»é‡ [120, 330, 500, 700, 1000]
    // rates: å°æ‡‰è²»ç‡ [1.78, 2.55, 3.80, 5.14, 6.44, 8.86]
    function calculateElectricityCostTaiPower(usage) {
      const brackets = [120, 330, 500, 700, 1000];
      const rates = [1.78, 2.55, 3.80, 5.14, 6.44, 8.86];
      let cost = 0;
      for (let i = 0; i <= brackets.length; i++) {
        const lower = i === 0 ? 0 : brackets[i - 1];
        const upper = i < brackets.length ? brackets[i] : Infinity;
        cost += Math.min(Math.max(usage - lower, 0), upper - lower) * rates[i];
      }
      return { total: cost };
    }

    // æ›´æ–°åœ–è¡¨ï¼šæ ¹æ“šæœ€æ–°çš„ç”¨é›»è¨˜éŒ„æ›´æ–°è¶¨å‹¢åœ–
    function updateChart() {
      usageChart.data.labels = records.map(r => r.month);
      usageChart.data.datasets[0].data = records.map(r => r.usage);
      usageChart.update();
    }

    // æ¸²æŸ“è¡¨æ ¼ï¼šé¡¯ç¤ºé›»è²»è¨˜éŒ„ã€è¨ˆç®—ç¸½ç”¨é‡å’Œå¹³å‡å–®åƒ¹
    function renderTable() {
      recordTableBody.innerHTML = "";
      let totalCost = 0, totalUsage = 0;

      records.forEach((rec, idx) => {
        const { total } = calculateElectricityCostTaiPower(rec.usage);
        totalCost += total;
        totalUsage += rec.usage;
        const avgPrice = rec.usage ? (total / rec.usage).toFixed(2) : 0;

        recordTableBody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${rec.month}</td>
            <td>${rec.usage}</td>
            <td>${total.toFixed(2)}</td>
            <td>${avgPrice}</td>
            <td><span class="btn-delete" data-idx="${idx}">åˆªé™¤</span></td>
          </tr>
        `);
      });

      document.getElementById("totalCost").textContent = totalCost.toFixed(2) + " å…ƒ";
      document.getElementById("totalUsage").textContent = totalUsage + " åº¦";
      document.getElementById("avgPrice").textContent = totalUsage ? (totalCost / totalUsage).toFixed(2) + " å…ƒ/åº¦" : "0 å…ƒ/åº¦";
      updateChart();
    }

    // è¨»å†Šè¡¨å–®åˆ‡æ›
    showRegister.addEventListener("click", e => {
      e.preventDefault();
      loginForm.classList.add("d-none");
      registerForm.classList.remove("d-none");
      msgBox.textContent = "";
    });

    // ç™»å…¥è¡¨å–®åˆ‡æ›
    showLogin.addEventListener("click", e => {
      e.preventDefault();
      registerForm.classList.add("d-none");
      loginForm.classList.remove("d-none");
      msgBox.textContent = "";
    });

    // ä½¿ç”¨è€…è¨»å†Šè™•ç†
    registerForm.addEventListener("submit", e => {
      e.preventDefault();
      const username = document.getElementById("regUsername").value.trim();
      const password = document.getElementById("regPassword").value;
      const confirm = document.getElementById("regConfirm").value;

      if (password !== confirm) {
        msgBox.textContent = "å¯†ç¢¼ä¸ä¸€è‡´";
        return;
      }

      users = JSON.parse(localStorage.getItem("users")) || {};
      if (users[username]) {
        msgBox.textContent = "å¸³è™Ÿå·²å­˜åœ¨";
        return;
      }

      users[username] = { password, records: [] };
      localStorage.setItem("users", JSON.stringify(users));
      msgBox.textContent = "è¨»å†ŠæˆåŠŸ";
      registerForm.reset();
      registerForm.classList.add("d-none");
      loginForm.classList.remove("d-none");
    });

    // ä½¿ç”¨è€…ç™»å…¥è™•ç†
    loginForm.addEventListener("submit", e => {
      e.preventDefault();
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value;
      users = JSON.parse(localStorage.getItem("users")) || {};

      if (!users[username]) {
        msgBox.textContent = "ç„¡æ­¤å¸³è™Ÿ";
        return;
      }
      if (users[username].password !== password) {
        msgBox.textContent = "å¯†ç¢¼éŒ¯èª¤";
        return;
      }

      localStorage.setItem("currentUser", username);
      loginForm.reset();
      document.getElementById("userName").textContent = username;
      showPage('dashboardPage');
      loadUserData();
    });

    // ç™»å‡ºè™•ç†
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("currentUser");
      showPage('loginPage');
    });

    // æ·±è‰²æ¨¡å¼åˆ‡æ›
    document.getElementById("toggleDark").addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
    });

    // åˆªé™¤æ‰€æœ‰é›»è²»ç´€éŒ„
    document.getElementById("deleteRecordsBtn").addEventListener("click", () => {
      if (window.confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰é›»è²»ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) {
        const currentUser = localStorage.getItem("currentUser");
        records = [];
        users[currentUser].records = records;
        localStorage.setItem("users", JSON.stringify(users));
        renderTable();
      }
    });

    // æ–°å¢é›»è²»ç´€éŒ„è™•ç†
    document.getElementById("recordForm").addEventListener("submit", e => {
      e.preventDefault();
      const month = document.getElementById("recordMonth").value;
      const usage = parseFloat(document.getElementById("recordUsage").value);
      records.push({ month, usage });
      const currentUser = localStorage.getItem("currentUser");
      users[currentUser].records = records;
      localStorage.setItem("users", JSON.stringify(users));
      renderTable();
      e.target.reset();
    });

    // åˆªé™¤å–®ç­†é›»è²»ç´€éŒ„
    recordTableBody.addEventListener("click", e => {
      if (e.target.classList.contains("btn-delete")) {
        const idx = e.target.dataset.idx;
        records.splice(idx, 1);
        const currentUser = localStorage.getItem("currentUser");
        users[currentUser].records = records;
        localStorage.setItem("users", JSON.stringify(users));
        renderTable();
      }
    });

    // åœ–è¡¨åˆå§‹åŒ–ï¼šè¨­ç½®ç”¨é›»è¶¨å‹¢åœ–çš„é…ç½®
    const ctx = document.getElementById("usageChart").getContext("2d");
    const usageChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "ç”¨é›»é‡ (åº¦)",
          data: [],
          backgroundColor: "rgba(13,110,253,0.2)",
          borderColor: "#0d6efd",
          borderWidth: 2,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { 
            beginAtZero: true,
            ticks: { maxTicksLimit: 8 }
          },
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 45
            }
          }
        },
        plugins: {
          legend: { position: 'top' }
        }
      }
    });

    // åˆå§‹åŒ–ï¼šæª¢æŸ¥ç™»å…¥ç‹€æ…‹ä¸¦è¼‰å…¥é©ç•¶é é¢
    if (localStorage.getItem("currentUser")) {
      document.getElementById("userName").textContent = localStorage.getItem("currentUser");
      showPage('dashboardPage');
      loadUserData();
    } else {
      showPage('loginPage');
    }
  </script>
</body>
</html>