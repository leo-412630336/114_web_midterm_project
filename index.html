<script>
    /* --- DOM 元素選取 --- */
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const showRegister = document.getElementById("showRegister");
    const showLogin = document.getElementById("showLogin");
    const msgBox = document.getElementById("msgBox");
    const recordTableBody = document.getElementById("recordTableBody");
    
    /* --- 全域變數 --- */
    let users = {}; // 用於儲存所有使用者資料
    let records = []; // 用於儲存目前登入者的電費紀錄

    /* --- 靜態資料：節能小提示 --- */
    const energyTips = [
      "隨手關燈，拔掉不用的電器插頭。",
      "將冷氣溫度設定在 26-28 度，搭配電扇使用更省電。",
      "優先選購具有「節能標章」的電器產品。",
      "定期清潔冷氣濾網，可提升冷房效果並省電。",
      "使用 LED 燈泡替換傳統燈泡，可節省大量電力。",
      "白天多利用自然光，減少開燈時間。",
      "冰箱不要塞太滿，並減少開關門次數。"
    ];

    /* --- 功能：顯示隨機節能小提示 --- */
    function showRandomTip() {
      const tipElement = document.getElementById("tipOfTheDay");
      if (tipElement) {
        const randomIndex = Math.floor(Math.random() * energyTips.length);
        tipElement.textContent = energyTips[randomIndex];
      }
    }

    /* --- 功能：切換頁面 (SPA 核心) --- */
    // 透過切換 'active' class 來顯示或隱藏登入頁面或儀表板
    function showPage(pageId) {
      document.querySelectorAll('#loginPage, #dashboardPage').forEach(page => page.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
    }

    /* --- 功能：載入並初始化使用者資料 --- */
    function loadUserData() {
      const currentUser = localStorage.getItem("currentUser");
      users = JSON.parse(localStorage.getItem("users")) || {};
      // 從全域 users 物件中，取得當前使用者的 records
      records = users[currentUser].records || [];
      
      // 載入資料後，重新渲染表格和圖表
      renderTable();
      // 顯示一則隨機小提示
      showRandomTip();
    }

    /* --- 功能：計算台電電費 (累進費率) --- */
    // 根據台灣的累進費率計算電費
    function calculateElectricityCostTaiPower(usage) {
      const brackets = [120, 330, 500, 700, 1000]; // 用電級距
      const rates = [1.78, 2.55, 3.80, 5.14, 6.44, 8.86]; // 對應費率
      let cost = 0;
      // 遍歷所有級距來計算總電費
      for (let i = 0; i <= brackets.length; i++) {
        const lower = i === 0 ? 0 : brackets[i - 1];
        const upper = i < brackets.length ? brackets[i] : Infinity;
        cost += Math.min(Math.max(usage - lower, 0), upper - lower) * rates[i];
      }
      return { total: cost };
    }

    /* --- 功能：更新 Chart.js 圖表 --- */
    function updateChart() {
      // 將 records 陣列資料轉換為圖表需要的格式
      usageChart.data.labels = records.map(r => r.month);
      usageChart.data.datasets[0].data = records.map(r => r.usage);
      // 更新圖表
      usageChart.update();
    }

    /* --- 功能：渲染表格 & 更新儀表板統計 --- */
    // 這是核心功能，負責計算、顯示所有資料
    function renderTable() {
      recordTableBody.innerHTML = ""; // 清空表格
      let totalCost = 0, totalUsage = 0;
      const co2Factor = 0.495; // 碳排放係數 (kg CO2 / 度)

      // 遍歷所有紀錄
      records.forEach((rec, idx) => {
        const { total } = calculateElectricityCostTaiPower(rec.usage); // 計算單筆電費
        totalCost += total; // 累加總電費
        totalUsage += rec.usage; // 累加總用電
        const avgPrice = rec.usage ? (total / rec.usage).toFixed(2) : 0; // 計算平均單價

        // 根據用電量高低，給予不同的 class (用於 CSS 上色)
        let usageClass = 'usage-low';
        if (rec.usage > 700) {
          usageClass = 'usage-high';
        } else if (rec.usage > 330) {
          usageClass = 'usage-medium';
        }
        
        // 將組合好的 HTML 插入表格中
        recordTableBody.insertAdjacentHTML('beforeend', `
          <tr class="${usageClass}">
            <td>${rec.month}</td>
            <td>${rec.usage}</td>
            <td>${total.toFixed(2)}</td>
            <td>${avgPrice}</td>
            <td><span class="btn-delete" data-idx="${idx}">刪除</span></td>
          </tr>
        `);
      });

      // 更新儀表板頂端的四個統計卡片
      document.getElementById("totalCost").textContent = totalCost.toFixed(2) + " 元";
      document.getElementById("totalUsage").textContent = totalUsage + " 度";
      document.getElementById("avgPrice").textContent = totalUsage ? (totalCost / totalUsage).toFixed(2) + " 元/度" : "0 元/度";
      
      // 計算並更新總碳排放
      const totalCO2 = totalUsage * co2Factor;
      document.getElementById("totalCO2").textContent = totalCO2.toFixed(2) + " kg";
      
      // 最後，更新圖表
      updateChart();
    }

    /* --- 事件監聽：點擊「註冊」連結 --- */
    showRegister.addEventListener("click", e => {
      e.preventDefault();
      loginForm.classList.add("d-none");
      registerForm.classList.remove("d-none");
      msgBox.textContent = "";
    });

    /* --- 事件監聽：點擊「登入」連結 --- */
    showLogin.addEventListener("click", e => {
      e.preventDefault();
      registerForm.classList.add("d-none");
      loginForm.classList.remove("d-none");
      msgBox.textContent = "";
    });

    /* --- 事件監聽：註冊表單提交 --- */
    registerForm.addEventListener("submit", e => {
      e.preventDefault();
      const username = document.getElementById("regUsername").value.trim();
      const password = document.getElementById("regPassword").value;
      const confirm = document.getElementById("regConfirm").value;

      if (password !== confirm) {
        msgBox.textContent = "密碼不一致";
        return;
      }

      users = JSON.parse(localStorage.getItem("users")) || {};
      if (users[username]) {
        msgBox.textContent = "帳號已存在";
        return;
      }

      // 建立使用者並包含空紀錄陣列
      users[username] = { password, records: [] };
      localStorage.setItem("users", JSON.stringify(users));
      msgBox.textContent = "註冊成功";
      
      // 註冊成功後，自動切換回登入表單
      registerForm.reset();
      registerForm.classList.add("d-none");
      loginForm.classList.remove("d-none");
    });

    /* --- 事件監聽：登入表單提交 --- */
    loginForm.addEventListener("submit", e => {
      e.preventDefault();
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value;
      users = JSON.parse(localStorage.getItem("users")) || {};

      if (!users[username]) {
        msgBox.textContent = "無此帳號";
        return;
      }
      if (users[username].password !== password) {
        msgBox.textContent = "密碼錯誤";
        return;
      }

      // 登入成功：儲存使用者，並切換到儀表板頁面
      localStorage.setItem("currentUser", username);
      loginForm.reset();
      document.getElementById("userName").textContent = username;
      showPage('dashboardPage');
      
      // 載入該使用者的資料
      loadUserData();
    });

    /* --- 事件監聽：點擊「登出」按鈕 --- */
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("currentUser");
      showPage('loginPage'); // 切換回登入頁面
    });

    /* --- 事件監聽：點擊「切換深色模式」按鈕 --- */
    document.getElementById("toggleDark").addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
    });

    /* --- 事件監聽：點擊「刪除所有紀錄」按鈕 --- */
    document.getElementById("deleteRecordsBtn").addEventListener("click", () => {
      // 顯示確認對話框
      if (window.confirm("確定要刪除所有電費紀錄嗎？此操作無法復原。")) {
        const currentUser = localStorage.getItem("currentUser");
        records = []; // 清空記憶體中的紀錄
        users[currentUser].records = records; // 更新全域 users 物件
        localStorage.setItem("users", JSON.stringify(users)); // 寫回 localStorage
        renderTable(); // 重新渲染表格 (變為空白)
      }
    });

    /* --- 事件監聽：新增紀錄表單提交 --- */
    document.getElementById("recordForm").addEventListener("submit", e => {
      e.preventDefault();
      const month = document.getElementById("recordMonth").value;
      const usage = parseFloat(document.getElementById("recordUsage").value);
      
      // 新增資料到記憶體中的 records 陣列
      records.push({ month, usage });
      
      // 更新 localStorage
      const currentUser = localStorage.getItem("currentUser");
      users[currentUser].records = records;
      localStorage.setItem("users", JSON.stringify(users));
      
      renderTable(); // 重新渲染表格
      e.target.reset(); // 重設表單
      showRandomTip(); // 新增後顯示新的提示
    });

    /* --- 事件監聽：點擊表格中的「刪除」 --- */
    // 這是「事件委派」(Event Delegation)，監聽整個 tbody
    recordTableBody.addEventListener("click", e => {
      // 判斷被點擊的是否為「刪除」按鈕
      if (e.target.classList.contains("btn-delete")) {
        const idx = e.target.dataset.idx; // 獲取 data-idx 屬性
        
        // 從陣列中刪除該筆資料
        records.splice(idx, 1);
        
        // 更新 localStorage
        const currentUser = localStorage.getItem("currentUser");
        users[currentUser].records = records;
        localStorage.setItem("users", JSON.stringify(users));
        
        renderTable(); // 重新渲染表格
      }
    });

    /* --- Chart.js 圖表初始化 --- */
    const ctx = document.getElementById("usageChart").getContext("2d");
    const usageChart = new Chart(ctx, {
      type: "line", // 設定為折線圖
      data: {
        labels: [], // 初始為空，將由 renderTable() 填入
        datasets: [{
          label: "用電量 (度)",
          data: [], // 初始為空
          backgroundColor: "rgba(13,110,253,0.2)",
          borderColor: "#0d6efd",
          borderWidth: 2,
          fill: true // 顯示線條下方的顏色
        }]
      },
      options: {
        responsive: true, // 響應式
        maintainAspectRatio: false, // 允許圖表不按原比例縮放
        scales: {
          y: { // Y 軸設定
            beginAtZero: true,
            ticks: { maxTicksLimit: 8 }
          },
          x: { // X 軸設定
            ticks: {
              maxRotation: 45, // 標籤旋轉 45 度，防止重疊
              minRotation: 45
            }
          }
        },
        plugins: {
          legend: { position: 'top' } // 圖例顯示在頂部
        }
      }
    });

    /* --- 程式進入點：檢查是否已登入 --- */
    // 當頁面載入時，檢查 localStorage 是否有 'currentUser'
    if (localStorage.getItem("currentUser")) {
      // 如果有，表示已登入
      document.getElementById("userName").textContent = localStorage.getItem("currentUser");
      showPage('dashboardPage'); // 顯示儀表板
      loadUserData(); // 載入使用者資料
    } else {
      // 如果沒有，表示未登入
      showPage('loginPage'); // 顯示登入頁面
    }
  </script>
</body>
</html>